<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NewPeer</title>
</head>
<h1>New peer joined</h1>
<body>
<script src="http://cdn.socket.io/socket.io-1.3.7.js"></script>
<script src="peer.js"></script>
<script type="text/javascript">
    window.onload = function(){
        var socket = io.connect('http://localhost:8000');
        console.log('new peer join');
        var peerSign = getUrlVars()['peerSign'];
        console.log('peerSign '+peerSign);
        var peerNumber = 3, peerChoice = 0;
        var id=0, peer,fileData;

        socket.on('newid',function(newid){
            if(!id) {
                id = newid;
                receiveConnection(id);

            }
            else{
                console.log('new id'+ newid);
                //newID = newId;
                connectPeer(newid);
                connectPeer(100);
            }
        });


        socket.on('choice', function(number){
            peerChoice = number;
            console.log('peerChoice '+ peerChoice);
            peerState();
            console.log('cureentid' + id);
        });

        // Read a page's GET URL variables and return them as an associative array.
        function getUrlVars()
        {
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++)
            {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }


        function peerState(){
            if (peerChoice == peerSign){
                window.open('http://localhost:63342/examples/videochat/NewPeer.html?peerSign='+peerSign);
                window.close();

            }

//            else{
//                socket.on('newid',function(newId){
//                    console.log('that new peer id'+ newId);
//                    //newID = newId;
//                    connectPeer(newId);
//                    connectPeer(100);
//                });
//                //connectPeer(100);
//
//            }
        }


        function receiveConnection(id){
            var peerData = [], i = 0;
            peer = new Peer(id , {host:'localhost', port:9000, debug:3});

            peer.on('open', function(){
                console.log('this new peer id '+ peer.id);
            });
            peer.on('connection', function(conn) {
                i += 1;
                console.log('connection ' + i);
                conn.on('open', function () {
                    conn.on('data', function (data) {
                        peerData.push(data);
                        // new fileData is peerData of last round
                        fileData = peerData;
                        console.log(peerData);
//                        if (i=== peerNumber-1){
//                            connectPeer(100);
//                        }
                if(fileData[1]){
                    connectPeer(100);
                }


                    });
                });
            });
        }

        function connectPeer(Id){
            //var peer = new Peer('101', {host:'localhost', port:9000, debug:3});
            var conn = peer.connect(Id);
            conn.on('open', function(){
                conn.send(fileData);
                //setTimeout(conn.close(),500);
            },false);

        }
    }

</script>

</body>
</html>
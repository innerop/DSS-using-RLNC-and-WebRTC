<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>peer1</title>
</head>
<body>
<h1>Peer1</h1>
<div>
    Select the file:
    <input type="file" id="fileInput">
</div>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="http://cdn.socket.io/socket.io-1.3.7.js"></script>
<script src="peer.js"></script>
<script src="download.js"></script>
<script>
    window.onload = function(){
        var id = 101 , peerNumber = 3,  fileData;
        var fileInput = document.getElementById('fileInput');
        var peer = new Peer(id, {host:'localhost', port:9000, debug:3});
        var socket, nextSign = false,peerChoice = 0;
        /*socket.on('message',function(data){
            console.log(data);
            socket.send('hello,the server!');
        }); */

        //read local file
        fileInput.addEventListener('change', function(){
            var file = fileInput.files[0];
            var reader = new FileReader;

            reader.onload = function(){
                fileData = reader.result;
                //data=JSON.stringify(reader.result);
            }
            reader.readAsBinaryString(file);
            //
//            for (var i=1;i<=2;i++){
//                socket.emit('roundNo1',i);
//                socket.on('start',function(sign){
//                    if (sign === 'go'){
//                        peerState();
//                        console.log('newid'+id);
//                    }
//                });
//
//            }

            socket = io.connect('http://localhost:8000');
            // listen start
            socket.on('start',function(sign){
                if (sign==='go'){
                    choose();
                    //peerState();
                    console.log('newid'+id);
                }

            });
//            //listen next round
//            socket.on('nextRound',function(sign){
//                if (sign === 'true'){
//                    nextSign = true;
//                    console.log(nextSign);
//                    choose();
//                    //nextRound();
//                }
//            });


        });

        // listen choice, listend number then start next round
        function choose(){
            socket.on('choice', function(number){
                peerChoice = number;
                console.log(peerChoice);
                peerState();
                console.log('cureentid' + id);
            });

        }


        function nextRound(){
//            socket.disconnect();
//            socket = io.connect('http://localhost:8000');
            peerState();
            console.log('newid' + id);

        }

        function peerState(){
            //var peerFailRate = 0.33;
            var newID;
            if (peerChoice == 1){
                peer.destroy();
                socket.disconnect();
                socket.connect();
                //socket.socket.reconnect();
                //generate new id and send this id to the server
                newID = id + peerNumber;
                //send the new id to the server
                socket.emit('peerid', newID);
                fileData = null;
                //new construct a peer and receive the data from other peer
                receiveConnection(newID);
                id = newID;
                peerChoice = 0;


            }


            else{
                //listen the new comer's id
                socket.on('newid',function(newId){
                    console.log(newId);
                    //newID = newId;
                    connectPeer(newId);
                    connectPeer(100);
                });
               //connectPeer(100);
            }
        }

        // generate new peer, listen connection from other peers
        //and then send the received data to the collector
        function receiveConnection(newID){
            var peerData = [], i = 0;
            peer = new Peer(newID, {host:'localhost', port:9000, debug:3});

            peer.on('open', function(){
                console.log(peer.id);
            });
            peer.on('connection', function(conn){
                i+=1;
                console.log('connection'+ i);
                conn.on('open',function(){
                    conn.on('data',function(data){
                            peerData.push(data);
                            // new fileData is peerData of last round
                            fileData = peerData;
                            console.log(peerData);
//                            if (i=== peerNumber-1){
                                connectPeer(100);
//                            }




                    });
                });
//
//                if (i>=2){
//
//                    var conn = peer.connect(100);
//                    conn.on('open',function(){
//                        console.log(peerData);
//                        conn.send(peerData);
//                    });
//                }
            });
        }

        // current peer connect to appointed peer and send data
        function connectPeer(newId){
            //var peer = new Peer('101', {host:'localhost', port:9000, debug:3});
            var conn = peer.connect(newId);
            conn.on('open', function(){
                conn.send(fileData);
            },false);

        }




    }
</script>

</body>
</html>
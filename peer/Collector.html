<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Receive and download</title>
    <link rel="stylesheet" type="text/css" href="engine.css">
</head>
<body>
<h1>Receive a file and download from another peer</h1>
<div>
    Source file:
    <input type="file" id="fileInput">
</div>
<p>Decoded data:</p>
<div>
    <pre id="fileDisplayArea"></pre>
</div>
<div>
    Retrieve state:
    <p id="decodeState"></p>
</div>
<p>Round count: &nbsp;<span id="roundCount"></span></p>


<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
<script src="http://cdn.socket.io/socket.io-1.3.7.js"></script>
<script src="peer.js"></script>
<script src="kodo.js"></script>
<script src="diff.js"></script>
<script>
    var kodo = Module;

    // parse url
    // Read a page's GET URL variables and return them as an associative array.
    function getUrlVars()
    {
        var vars = [], hash;
        var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
        for(var i = 0; i < hashes.length; i++)
        {
            hash = hashes[i].split('=');
            vars.push(hash[0]);
            vars[hash[0]] = hash[1];
        }
        return vars;
    }
    var Q = parseInt(getUrlVars()['Q']), symbols = parseInt(getUrlVars()['symbols']),symbolSize = parseInt(getUrlVars()['symbolSize']);
    var peerNumber = 10, dataIn, dataOut;

    window.onload = function(){

        var fileDisplayArea = document.getElementById('fileDisplayArea');
        var decodeState = $("#decodeState");
        var result = [];
        var roundCount = 0,i=0;

        //create PeerJs object receive connection
        var peer = new Peer('100', {host:'localhost', port:9000, debug:3});
        var socket = io.connect('http://localhost:8000');
        roundReceive();

        function roundReceive(){

            peer.on('open', function(){
                console.log(peer.id);

            });

            //receive the connection from another peer

            //Emitted when a new data connection is established from a remote peer
            peer.on('connection',function(conn){
                i += 1;
                console.log(i);
                //Set listeners for data connection events.
                //Emitted when the connection is established and ready-to-use.
                conn.on('open', function(){

                    //receive data
                    //Emitted when data is received from the remote peer.
                    conn.on('data', function(data){
                        for(var i=0;i<data.length;i++){
                            result.push(data[i]);
                        }
                        //download(file.content,file.fileName, file.fileType);
                        console.log('coded data array: ');
                        console.log(result);
                        conn.close();
                        if (result.length===Q*peerNumber){
                            decoding(result);

                        }
                        else if(result.length<Q*peerNumber){
                            $('#decodeState').css({'color':'red'});
                            decodeState.text(' Received coded packets not enough');

                        }

                    });
                });

            });
        }


        function sendSign(){
            //console.log('result'+result);
            result = [];
            i = 0;
            socket.emit('nextRound','true');
        }

        function decoding(data){
            //var symbols = 9, symbolSize = 400;

            decoder_factory = new kodo.decoder_factory(symbols,symbolSize);
            decoder = decoder_factory.build();

            for(var i=0; i<data.length;i++){
                decoder.read_payload(data[i]);
                console.log(decoder.rank()+'/'+ decoder.symbols());

            }
            dataOut = decoder.copy_from_symbols();
            fileDisplayArea.innerText = dataOut;
            verifyDecode(dataIn);

        }

            //read the source file
            //var fileInput = $("#fileInput")[0];//convert jquery object to DOM object
            $("#fileInput").change(function(){
                var file = $('#fileInput')[0].files[0];
                var reader = new FileReader;
                reader.onload = function(){
                    dataIn = reader.result;
                    //verifyDecode(dataIn);

                }
                reader.readAsBinaryString(file);

            });

        function verifyDecode(dataIn){
            roundCount += 1;
            $('span').text(roundCount);
            var diff = JsDiff.diffWords(dataOut,dataIn);
            console.log('compare result:');
            console.log(diff);
            if(diff.length<3 && diff.length>0) {
                $('#decodeState').css({'color': '#32cd32'});
                decodeState.text('Decode correct, retrieve source file success!!!');
                sendSign()
            }

            else{
                $('#decodeState').css({'color':'red'});
                decodeState.text('Problem occurs');
            }
        }

    }


</script>

</body>
</html>